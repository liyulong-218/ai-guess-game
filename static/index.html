<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ç™¾ç§‘çŒœè¯ - å¤šç”¨æˆ·ç‰ˆ</title>
    <style>
        :root {
            --primary: #007bff;
            --success: #28a745;
            --hint: #17a2b8;
            --danger: #dc3545;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --text: #333;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; text-align: center; background: var(--bg); color: var(--text); user-select: none; }
        h1 { margin-bottom: 20px; font-size: 28px; }
        
        /* --- ç™»å½•å±‚æ ·å¼ --- */
        #login-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 999; display: flex; align-items: center; justify-content: center; flex-direction: column; backdrop-filter: blur(5px); }
        .login-box { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; max-width: 90%; width: 400px; }
        .login-box h2 { margin-top: 0; color: var(--primary); }
        .login-input { width: 100%; padding: 14px; font-size: 18px; margin: 10px 0 5px 0; border: 2px solid #eee; border-radius: 8px; box-sizing: border-box; outline: none; transition: border-color 0.2s; text-align: center; }
        .login-input:focus { border-color: var(--primary); }
        .login-hint { font-size: 12px; color: #999; height: 18px; margin-bottom: 15px; display: block; }
        .login-hint.error { color: var(--danger); }
        .login-btn { width: 100%; padding: 14px; font-size: 18px; font-weight: bold; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; transition: transform 0.1s; }
        .login-btn:active { transform: scale(0.98); }

        /* --- ä¸»ç•Œé¢ç»Ÿè®¡æ  --- */
        .stats-bar { display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); padding: 12px 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; font-weight: 600; font-size: 14px; }
        .stat-item span { color: var(--primary); font-weight: bold; }
        .stat-item.hint-span span { color: var(--hint); }
        .stat-item.time-span span { color: #fd7e14; }

        /* --- ç›®æ ‡è¯ç½‘æ ¼ --- */
        .word-grid { display: flex; justify-content: center; gap: 8px; margin: 25px 0; flex-wrap: wrap; min-height: 50px; }
        .cell { width: 50px; height: 50px; background: #343a40; color: transparent; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; border-radius: 8px; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .cell.revealed { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .cell.user-guessed { background: var(--success); color: white; }
        .cell.hint-revealed { background: var(--hint); color: white; }
        .cell.punctuation { background: transparent; color: var(--text); font-size: 20px; box-shadow: none; transform: none; }

        /* --- æ§åˆ¶åŒº --- */
        .controls { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; align-items: center; }
        input[type="text"] { width: 220px; height: 60px; font-size: 20px; text-align: center; border: 2px solid #dee2e6; border-radius: 12px; outline: none; transition: border-color 0.2s; letter-spacing: 2px; }
        input[type="text"]:focus { border-color: var(--primary); }
        button { padding: 0 24px; height: 60px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; transition: transform 0.1s; }
        button:active { transform: scale(0.95); }
        .btn-guess { background: var(--primary); color: white; }
        .btn-hint { background: #ffc107; color: #333; }
        .btn-hint:disabled { background: #e0a800; opacity: 0.6; cursor: not-allowed; }
        .btn-next { background: var(--success); color: white; margin-top: 20px; padding: 12px 40px; font-size: 18px; border-radius: 30px; }

        /* --- 2. å¼±åŒ–æç¤º Toast (å±å¹•ä¸­é—´æµ®åŠ¨) --- */
        .toast-container {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            pointer-events: none; /* è®©é¼ æ ‡äº‹ä»¶ç©¿é€ */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .toast {
            background: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 500;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            white-space: nowrap;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast.success { background: rgba(40, 167, 69, 0.9); }
        .toast.error { background: rgba(220, 53, 69, 0.9); }
        .toast.info { background: rgba(108, 117, 125, 0.9); }

        /* æè¿°æ–‡æ¡ˆåŒº */
        .clue-card { background: var(--card-bg); padding: 25px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); text-align: left; line-height: 2.4; font-size: 18px; position: relative; margin-bottom: 20px; min-height: 100px; }
        .clue-char { display: inline-block; width: 24px; text-align: center; position: relative; }
        .clue-char.hidden { color: transparent; background: #e9ecef; border-radius: 4px; margin: 0 2px; height: 24px; }
        .clue-char.revealed { font-weight: 600; }
        .clue-char.user-guessed { color: var(--success); }
        .clue-char.hint-revealed { color: var(--hint); }
        .clue-char.punct { color: #adb5bd; background: transparent; width: auto; margin: 0 2px; }

        /* é”™è¯¯åˆ—è¡¨ (é»˜è®¤éšè—) */
        .wrong-container { margin: 0 0 25px 0; min-height: 24px; background: #fff; padding: 10px; border-radius: 8px; display: none; transition: all 0.3s; }
        .wrong-container.show { display: inline-block; }
        .wrong-label { color: var(--danger); font-weight: bold; font-size: 14px; margin-right: 8px; }
        .wrong-chars { display: inline; color: var(--danger); font-size: 14px; line-height: 1.6; word-break: break-all; }

        /* --- èƒœåˆ©æ¿€åŠ±å¡ç‰‡ --- */
        #success-card { display: none; background: linear-gradient(135deg, #e8f5e9 0%, #ffffff 100%); border: 2px solid var(--success); border-radius: 16px; padding: 25px; margin-top: 20px; animation: slideUp 0.5s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .success-title { font-size: 24px; color: var(--success); font-weight: bold; margin-bottom: 15px; }
        .success-stats { display: flex; justify-content: center; gap: 20px; margin-bottom: 15px; font-size: 16px; }
        .success-stat-item { background: white; padding: 8px 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .success-stat-item strong { display: block; font-size: 20px; color: var(--text); }
        .success-stat-item span { font-size: 12px; color: #666; }

        /* --- 3. Loading é®ç½©å±‚ --- */
        #loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95);
            z-index: 2000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .spinner {
            width: 50px; height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { font-size: 18px; color: #666; font-weight: 500; }

    </style>
</head>
<body>

    <!-- ç™»å½•å±‚ -->
    <div id="login-layer">
        <div class="login-box">
            <h2>ğŸ§  AI ç™¾ç§‘çŒœè¯</h2>
            <p style="color:#666; font-size:14px;">è¾“å…¥åå­—å¼€å§‹æŒ‘æˆ˜ï¼Œè®°å½•ä½ çš„ä¸“å±æˆ˜ç»©</p>
            <input type="text" id="username-input" class="login-input" placeholder="ä½ çš„åå­—" maxlength="12" name="game_player_name_random_123" autocomplete="off">
            <span id="login-hint" class="login-hint"></span>
            <button type="button" class="login-btn" onclick="handleLogin()">å¼€å§‹æ¸¸æˆ</button>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div id="main-game-ui" style="display:none;">
        <h1>ğŸ“– æ¯æ—¥ç™¾ç§‘çŒœè¯</h1>
        
        <div class="stats-bar">
            <div class="stat-item">ğŸ‘¤ <span id="display-username">Player</span></div>
            <div class="stat-item">ğŸ® æ€»å±€ï¼š<span id="stat-total">0</span></div>
            <div class="stat-item">ğŸ¯ å¹³å‡ï¼š<span id="stat-avg">0</span></div>
        </div>

        <div class="stats-bar" style="background: transparent; box-shadow: none; padding: 0; margin-bottom: 10px;">
            <div class="stat-item">çŒœæµ‹ï¼š<span id="attempt-count" style="color:#333">0</span></div>
            <div class="stat-item hint-span">ğŸ’¡ æç¤ºï¼š<span id="hint-count" style="color:#333">0</span></div>
            <!-- 1. æ—¶é—´æ˜¾ç¤ºæ ¼å¼ä¿®æ”¹ -->
            <div class="stat-item time-span">â±ï¸ ç”¨æ—¶ï¼š<span id="time-count" style="color:#333">0ç§’</span></div>
            <div class="stat-item" id="game-status" style="color:#666">åŠ è½½ä¸­...</div>
        </div>

        <div class="word-grid" id="word-grid"></div>

        <div class="controls">
            <input type="text" id="guess-input" autocomplete="off" placeholder="åªè¾“å…¥ä¸€ä¸ªå­—">
            <button class="btn-guess" onclick="submitGuess()">çŒœ</button>
            <button class="btn-hint" id="hint-btn" onclick="useHint()">ğŸ’¡ æç¤º</button>
        </div>

        <!-- 2. ç§»é™¤äº†åŸæ¥çš„ toast-msg divï¼Œæ”¹ç”¨æ–°çš„ toast-container -->
        <div class="toast-container" id="toast-container"></div>

        <div class="clue-card" id="clue-box">
            æ­£åœ¨ç”± AI ç”Ÿæˆé¢˜ç›®ä¸æè¿°...
        </div>

        <div class="wrong-container" id="wrong-container">
            <span class="wrong-label">ä¸åœ¨æè¿°ä¸­:</span>
            <span class="wrong-chars" id="wrong-list"></span>
        </div>

        <div id="success-card">
            <div class="success-title">ğŸ‰ æŒ‘æˆ˜æˆåŠŸ!</div>
            <div class="success-stats">
                <div class="success-stat-item">
                    <strong id="res-attempts" style="color:var(--primary)">0</strong>
                    <span>çŒœæµ‹æ¬¡æ•°</span>
                </div>
                <div class="success-stat-item">
                    <strong id="res-hints" style="color:var(--hint)">0</strong>
                    <span>ä½¿ç”¨æç¤º</span>
                </div>
                <div class="success-stat-item">
                    <strong id="res-time" style="color:#fd7e14">0ç§’</strong>
                    <span>æ€»ç”¨æ—¶</span>
                </div>
            </div>
            <!-- 3. ä¿®æ”¹æŒ‰é’®è¡Œä¸º -->
            <button class="btn-next" onclick="startNextGame()">ğŸ”„ æŒ‘æˆ˜ä¸‹ä¸€é¢˜</button>
        </div>
    </div>

    <!-- 3. æ–°å¢ Loading é®ç½©å±‚ -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text">AI æ­£åœ¨ç”Ÿæˆæ–°é¢˜ç›®...</div>
    </div>

<script>
    let currentUser = "";
    let startTime = 0;
    let timerInterval = null;
    
    let state = {
        word: "",
        clue: "",
        attempts: 0,
        hints: 0,
        revealed: new Set(),
        wrong: new Set(),
        userGuessedChars: new Set(),
        hintRevealedChars: new Set(),
        ended: false
    };

    // --- 1. ç™»å½•é€»è¾‘ ---
    async function handleLogin() {
        const input = document.getElementById('username-input');
        const hintEl = document.getElementById('login-hint');
        const name = input.value.trim();
        
        if (!name) {
            hintEl.innerText = "è¯·è¾“å…¥åå­—ä»¥å¼€å§‹";
            hintEl.classList.add('error');
            return;
        }
        hintEl.innerText = "";
        hintEl.classList.remove('error');

        try {
            const res = await fetch('/api/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: name})
            });
            const data = await res.json();
            
            if (data.status === 'success') {
                currentUser = data.username;
                document.getElementById('login-layer').style.display = 'none';
                document.getElementById('main-game-ui').style.display = 'block';
                document.getElementById('display-username').innerText = currentUser;
                loadUserStats();
                initGame();
            } else {
                throw new Error(data.message || "ç™»å½•å¤±è´¥");
            }
        } catch (e) {
            hintEl.innerText = e.message;
            hintEl.classList.add('error');
        }
    }

    async function loadUserStats() {
        try {
            const res = await fetch(`/api/get_user_stats?username=${encodeURIComponent(currentUser)}`);
            const data = await res.json();
            if (!data.error) {
                document.getElementById('stat-total').innerText = data.total_games;
                document.getElementById('stat-avg').innerText = data.avg_attempts;
            }
        } catch (e) { console.error("Stats load failed", e); }
    }

    // --- 2. æ¸¸æˆåˆå§‹åŒ– ---
    async function initGame() {
        clearInterval(timerInterval);
        document.getElementById('success-card').style.display = 'none';
        document.getElementById('game-status').innerText = "ç”Ÿæˆé¢˜ç›®ä¸­...";
        document.getElementById('guess-input').disabled = true;
        document.getElementById('hint-btn').disabled = true;
        document.getElementById('guess-input').value = '';
        
        try {
            const res = await fetch(`/api/init_game?username=${encodeURIComponent(currentUser)}`);
            const data = await res.json();
            if (data.error) throw new Error(data.error);
            
            state.word = data.debug_answer; 
            state.clue = data.clue;
            state.attempts = 0;
            state.hints = 0;
            state.revealed.clear();
            state.wrong.clear();
            state.userGuessedChars.clear();
            state.hintRevealedChars.clear();
            state.ended = false;
            
            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);

            document.getElementById('game-status').innerText = "æ¸¸æˆä¸­";
            document.getElementById('guess-input').disabled = false;
            document.getElementById('hint-btn').disabled = false;
            
            render();
            document.getElementById('guess-input').focus();
        } catch (e) {
            document.getElementById('clue-box').innerText = "âŒ åŠ è½½å¤±è´¥ï¼š" + e.message;
            document.getElementById('game-status').innerText = "é”™è¯¯";
            clearInterval(timerInterval);
        }
    }

    // --- 3. æ¸²æŸ“é€»è¾‘ ---
    function render() {
        document.getElementById('attempt-count').innerText = state.attempts;
        document.getElementById('hint-count').innerText = state.hints;

        const wGrid = document.getElementById('word-grid');
        wGrid.innerHTML = '';
        let wordSolved = true;
        
        [...state.word].forEach(c => {
            const div = document.createElement('div');
            div.className = 'cell';
            if (state.revealed.has(c)) {
                div.innerText = c;
                div.classList.add('revealed');
                if (state.userGuessedChars.has(c)) div.classList.add('user-guessed');
                else if (state.hintRevealedChars.has(c)) div.classList.add('hint-revealed');
            } else {
                wordSolved = false;
            }
            wGrid.appendChild(div);
        });

        const cBox = document.getElementById('clue-box');
        cBox.innerHTML = '';
        let clueSolved = true;
        
        [...state.clue].forEach(c => {
            const span = document.createElement('span');
            span.className = 'clue-char';
            const isPunct = /[^\w\u4e00-\u9fa5]/.test(c);
            
            if (isPunct || state.revealed.has(c)) {
                span.innerText = c;
                if (!isPunct) {
                    span.classList.add('revealed');
                    if (state.userGuessedChars.has(c)) span.classList.add('user-guessed');
                    else if (state.hintRevealedChars.has(c)) span.classList.add('hint-revealed');
                } else {
                    span.classList.add('punct');
                }
            } else {
                span.classList.add('hidden');
                span.innerText = c; 
                clueSolved = false;
            }
            cBox.appendChild(span);
        });

        if ((wordSolved || clueSolved) && !state.ended) {
            endGame();
        }
    }

    function renderWrongList() {
        const container = document.getElementById('wrong-container');
        const listEl = document.getElementById('wrong-list');
        if (state.wrong.size === 0) {
            container.classList.remove('show');
        } else {
            container.classList.add('show');
            listEl.innerText = Array.from(state.wrong).join(' ');
        }
    }

    // 1. æ—¶é—´æ ¼å¼åŒ–å‡½æ•°
    function updateTimer() {
        const delta = Math.floor((Date.now() - startTime) / 1000);
        const m = Math.floor(delta / 60);
        const s = delta % 60;
        // æ ¼å¼ï¼šxåˆ†xç§’
        document.getElementById('time-count').innerText = `${m}åˆ†${s}ç§’`;
    }

    // 2. å¼±åŒ– Toast æç¤ºå‡½æ•°
    function showToast(msg, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerText = msg;
        
        container.appendChild(toast);
        
        // å¼ºåˆ¶é‡ç»˜ä»¥è§¦å‘ transition
        requestAnimationFrame(() => {
            toast.classList.add('show');
        });

        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                toast.remove();
            }, 300);
        }, 2000);
    }

    // --- 4. æäº¤çŒœæµ‹ ---
    async function submitGuess() {
        if (state.ended) return;
        const input = document.getElementById('guess-input');
        const val = input.value.trim();
        
        if (!val) return;

        let foundAny = false;
        const charsToCheck = [...val]; 

        for (let char of charsToCheck) {
            if (state.revealed.has(char) || state.wrong.has(char)) continue; 

            const res = await fetch('/api/check_char', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ char, answer: state.word, clue: state.clue })
            });
            const data = await res.json();

            if (data.is_found) {
                state.revealed.add(char);
                state.userGuessedChars.add(char);
                foundAny = true;
            } else {
                state.wrong.add(char);
            }
            state.attempts++; 
        }

        input.value = '';
        input.focus();
        
        renderWrongList();
        render(); 

        // 2. ä½¿ç”¨æ–°çš„ Toast æç¤º
        if (foundAny) showToast("âœ… å‘ç°æ–°å­—ç¬¦", "success");
        else showToast("âŒ ä¸åœ¨æè¿°ä¸­", "error");
    }

    // --- 5. æç¤ºåŠŸèƒ½ ---
    async function useHint() {
        if (state.ended) return;
        const hiddenCharsInClue = [...state.clue].filter(c => {
            const isPunct = /[^\w\u4e00-\u9fa5]/.test(c);
            return !isPunct && !state.revealed.has(c);
        });

        if (hiddenCharsInClue.length === 0) {
            showToast("ğŸ’¡ æè¿°å·²å…¨éƒ¨æ­ç¤º", "info");
            return;
        }

        const randomChar = hiddenCharsInClue[Math.floor(Math.random() * hiddenCharsInClue.length)];
        state.hints++;
        state.revealed.add(randomChar);
        state.hintRevealedChars.add(randomChar);
        showToast(`ğŸ’¡ æ­ç¤ºäº† "${randomChar}"`, "info");
        render();
    }

    // --- 6. æ¸¸æˆç»“æŸ ---
    async function endGame() {
        state.ended = true;
        clearInterval(timerInterval);
        document.getElementById('game-status').innerText = "å·²å®Œæˆ";
        document.getElementById('guess-input').disabled = true;
        document.getElementById('hint-btn').disabled = true;

        [...state.clue].forEach(c => {
            if (!/[^\w\u4e00-\u9fa5]/.test(c)) {
                state.revealed.add(c);
            }
        });
        render(); 

        const totalTime = Math.floor((Date.now() - startTime) / 1000);
        const m = Math.floor(totalTime / 60);
        const s = totalTime % 60;
        const timeStr = `${m}åˆ†${s}ç§’`;

        try {
            await fetch('/api/finish_game', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    username: currentUser,
                    word: state.word,
                    clue: state.clue,
                    attempts: state.attempts,
                    hints: state.hints
                })
            });
            loadUserStats();
        } catch (e) { console.error("Save failed", e); }

        setTimeout(() => {
            document.getElementById('res-attempts').innerText = state.attempts;
            document.getElementById('res-hints').innerText = state.hints;
            document.getElementById('res-time').innerText = timeStr;
            document.getElementById('success-card').style.display = 'block';
            document.getElementById('success-card').scrollIntoView({ behavior: 'smooth' });
        }, 500);
    }

    // 3. ä¸‹ä¸€é¢˜é€»è¾‘ (å…ˆæ˜¾ç¤º Loading)
    async function startNextGame() {
        // æ˜¾ç¤º Loading é®ç½©
        document.getElementById('loading-overlay').style.display = 'flex';
        document.getElementById('success-card').style.display = 'none';
        
        // ç¨å¾®å»¶è¿Ÿä¸€ä¸‹å†è¯·æ±‚ï¼Œè®©ç”¨æˆ·çœ‹åˆ° Loading åŠ¨ç”»
        await new Promise(r => setTimeout(r, 300));
        
        try {
            const res = await fetch(`/api/init_game?username=${encodeURIComponent(currentUser)}`);
            const data = await res.json();
            if (data.error) throw new Error(data.error);
            
            // é‡ç½®çŠ¶æ€
            state.word = data.debug_answer; 
            state.clue = data.clue;
            state.attempts = 0;
            state.hints = 0;
            state.revealed.clear();
            state.wrong.clear();
            state.userGuessedChars.clear();
            state.hintRevealedChars.clear();
            state.ended = false;
            
            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);
            
            document.getElementById('game-status').innerText = "æ¸¸æˆä¸­";
            document.getElementById('guess-input').disabled = false;
            document.getElementById('hint-btn').disabled = false;
            
            render();
            document.getElementById('guess-input').value = '';
            document.getElementById('guess-input').focus();
            
            // éšè— Loadingï¼Œæ˜¾ç¤ºæ¸¸æˆ
            document.getElementById('loading-overlay').style.display = 'none';
            
        } catch (e) {
            alert("ç”Ÿæˆæ–°é¢˜ç›®å¤±è´¥ï¼š" + e.message);
            document.getElementById('loading-overlay').style.display = 'none';
        }
    }

    document.getElementById('guess-input').addEventListener('input', function() {
        this.placeholder = this.value.trim() === '' ? "åªè¾“å…¥ä¸€ä¸ªå­—" : "";
    });
    document.getElementById('guess-input').addEventListener('keypress', e => {
        if (e.key === 'Enter') submitGuess();
    });
    document.getElementById('username-input').addEventListener('keypress', e => {
        if (e.key === 'Enter') handleLogin();
    });

</script>
</body>
</html>
